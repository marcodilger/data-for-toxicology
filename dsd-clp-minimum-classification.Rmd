---
title: "CLP Minimum classifications"
author: "Marco Dilger"
date: "February 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl) # reads xlsx without outer dependencies
```

## Analysis of substances that are (mis)classified as less toxic as a result of the CLP Minimum classification

### Background
Replacement of the dangerous substance directive (DSD) by the CLP regulation prompted major re-classification work to adhere to the new criteria. The old and new classification criteria fur acute toxicity don't match 100%. In case of ambiguity, the minimum classification concept prompts classification into the CLP category of lower toxicity (*this needs a figure for explanation*)). This \~\~may\~\~did lead to classifications which are not supported by the experimental data, which can be shown e.g. by the REACH registration data.

### Get data with CLP classifications
ECHA provides (unofficial) tabular data of harmonized classifications [here](https://echa.europa.eu/information-on-chemicals/annex-vi-to-clp) in form of an excel file. The substances falling under the minimum classification are marked with an '*'.

Unfortunately it's only availabe as an excel file. The excel file contains text in the first 4 rows, the table headers in the next two rows, and the data starting with row 7. Parsing two rows as table headers is not suported by readxl::read_excel (don't know about xlsx::read.xlsx), but the [issue discussion](https://github.com/tidyverse/readxl/issues/486) on github provides a working solution. 

```{r get data}

headers <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", range = cell_rows(5:6), col_names = FALSE) %>%
  map(na.omit) %>% 
  map(paste, collapse = "_") %>% 
  as.character

clp_table <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", skip = 6, col_names = headers)
# ToDo: look into option .name_repair

glimpse(clp_table)
```
Many variables look messy. For the purpose of this analysis we only need the hazard class categories and some id of the substances. Dropping anything else and renaming the vars:

```{r dropping uneccessary vars}
clp_table <- clp_table %>%
  transmute(
    substance = `International Chemical Identification`,
    ec = `EC No`,
    cas = `CAS No`,
    clp_class = `Classification_Hazard Class and Category Code(s)`
  )
```


As expected, multiple hazard categories are contained in 1 excel cell. This needs to be tidied up first.
```{r tidying df}
clp_table_tidy <- clp_table %>%
  separate_rows(clp_class, sep = "\r\n") %>%
  filter(str_length(clp_class) > 0)
```

```{r extract minimum categorization}
clp_minimum <- clp_table_tidy %>%
  filter(str_detect(clp_class, "\\*$")) # select all observations where the hazard class category ends with '*'
```
2845 substances

## For how many of these substances does available data not support the classification?

### Sources of experimental data

* ECHA dissemination database: For the substances which are registered, this would certainly be the best source. Unfortunately, ECHA provides no API (subject to change) and it is a bit unclear whether scraping the webpage is allowed. (ECHA prohibits automated scraping of substantial amounts of data...but what is substantial?) 
* eChemportal: No API, but a batch search that should suffice for this purpose. Contains REACH data, but apparently that's only the 2017 database dump [(details here)](https://echa.europa.eu/-/data-on-15-000-chemicals-now-available-to-use), which would mean more recent data can't be found. **ToDo later: check if data from a post-2017 registration is included in eChemPortal**  
* OECD Toolbox: Contains the data from the 2017 REACH database dump. With considerable amount of details (e.g. test item information in natural language. **Need to check this**.  
* LRI Ambit2: [link](http://cefic-lri.org/toolbox/ambit2/). Also contains the data from the 2017 REACH db. Has an API? and is developed by Ideaconsult (good sign for data accessibility). **Need to check this**.  
* IUCLID API with db dump: IUCLID6 provides a REST API. However it is very slow and inconvenient: information is coded, codes are available in the iuclid-data dcumentation, but not readily in machine-readable format. Also study records not directly accessible/searchable, but only via the study record UUIDs which in turn have to be requested first with the dossier UUID etc... not a viable solution for quickly getting the acute tox data. *(further info/experience on IUCLID api wanted)*  
* EPA chemistry dashboard: Has some acute tox data without much details and without references. Exports apparently only the presence of data, not the values itself?  
* HSDB via PubChem or directly  
* NIOSH-RTECS via PubChem or directly. Direct access to RTECS probably difficult
* tbc: there must be more

### Conclusion where to get data
eChemportal or OECD Toolbox seems to be the best solution for now.

## Use data from eChemPortal to get acute toxicity effect levels

### Usage of the eChemPortal propertysearch

eChemPortals property search [link](https://www.echemportal.org/echemportal/propertysearch/page.action?pageID=10) allows to search the REACH dissemination database (from 2017, as explained above). To get data one has to build query blocks (which have a different structure for the different endpoints) which specify the requested variables. For acute oral toxicity, the query offers the variables

* Type of information (the type of study {experimental, QSAR, read-accross, ...} where the information came from)
* Reliability (Klimisch Reliability scores)
* Reference, Year (Year of the study)
* Testguideline qualifier and guideline
* GLP compliance (not necessary for the current purpose)
* Test type (type of the study protocol {acute toxic class, up-and-down, ...})
* Species and Strain
* Route of administration
* Effect levels, Dose descriptor {approximate LD50, discriminating dose, LD0, LD100, LD50, LD50 cut-off, LDLo, other:}
* Effect levels, Effect level (the dose corresponding to the dose descriptor)
* Effect levels, Remarks on result (ignored)
* Interpretation of results (categorization according to GHS criteria, very useful in the current context)

There are two issues regarding the data export function
1. The fields are AND connected and fields with missing values lead to exclusion of the whole entry form the exported results. If a variable is left blank in the query, it is not included in the result.  
2. Exports are limited to 10000 observations (i.e. study results).

Both problems can be circumvented by creating various queries and joining the data by other means. The second is quite easily managable by splitting a queries in two year ranges. As every study report should have a reference year given, this should not lead to exclusion of studies. The first "just" needs an additional "layer" of distinct queries for every varibale that should be exported.





```{r echemportal deprecated}
clp_minimum %>%
  pull(cas) %>%
  write("export_for_epa_dashboard.txt")


read_csv("data/ChemistryDashboard-Batch-Search_2019-02-07_12_36_31.csv")
```
