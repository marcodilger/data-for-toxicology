---
title: "CLP Minimum classifications"
author: "Marco Dilger"
date: "February 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl) # reads xlsx without outer dependencies
```

## Analysis of substances that are (mis)classified as less toxic as a result of the CLP Minimum classification

### Background
Replacement of the dangerous substance directive (DSD) by the CLP regulation prompted major re-classification work to adhere to the new criteria. The old and new classification criteria fur acute toxicity don't match 100%. In case of ambiguity, the minimum classification concept prompts classification into the CLP category of lower toxicity (*this needs a figure for explanation*)). This \~\~may\~\~did lead to classifications which are not supported by the experimental data, which can be shown e.g. by the REACH registration data.

### Get data with CLP classifications
ECHA provides (unofficial) tabular data of harmonized classifications [here](https://echa.europa.eu/information-on-chemicals/annex-vi-to-clp) in form of an excel file. The substances falling under the minimum classification are marked with an '*'.

Unfortunately it's only availabe as an excel file. The excel file contains text in the first 4 rows, the table headers in the next two rows, and the data starting with row 7. Parsing two rows as table headers is not suported by readxl::read_excel (don't know about xlsx::read.xlsx), but the [issue discussion](https://github.com/tidyverse/readxl/issues/486) on github provides a working solution. 

```{r get data}

headers <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", range = cell_rows(5:6), col_names = FALSE) %>%
  map(na.omit) %>% 
  map(paste, collapse = "_") %>% 
  as.character

clp_table <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", skip = 6, col_names = headers)
# ToDo: look into option .name_repair

glimpse(clp_table)
```
Many variables look messy. For the purpose of this analysis we only need the hazard class categories and some id of the substances. Dropping anything else and renaming the vars:

```{r dropping uneccessary vars}
clp_table <- clp_table %>%
  transmute(
    substance = `International Chemical Identification`,
    ec = `EC No`,
    cas = `CAS No`,
    clp_class = `Classification_Hazard Class and Category Code(s)`,
    h_code = `Hazard Statement Code(s)`
  )
```


As expected, multiple hazard categories are contained in 1 excel cell. This needs to be tidied up first.
```{r tidying df}
clp_table_tidy <- clp_table %>%
  separate_rows(clp_class, h_code, sep = "\r\n") %>%
  filter(str_length(clp_class) > 0)

clp_table_tidy %>% pull(clp_class) %>% 
  table %>% sort
```

```{r extract minimum categorization}
clp_minimum <- clp_table_tidy %>%
  filter(str_detect(clp_class, "\\*$")) # select all observations where the hazard class category ends with '*'
```
2845 substances

## For how many of these substances does available data not support the classification?

### Sources of experimental data

* ECHA dissemination database: For the substances which are registered, this would certainly be the best source. Unfortunately, ECHA provides no API (subject to change) and it is a bit unclear whether scraping the webpage is allowed. (ECHA prohibits automated scraping of substantial amounts of data...but what is substantial?) 
* eChemportal: No API, but a batch search that should suffice for this purpose. Contains REACH data, but apparently that's only the 2017 database dump [(details here)](https://echa.europa.eu/-/data-on-15-000-chemicals-now-available-to-use), which would mean more recent data can't be found. **ToDo later: check if data from a post-2017 registration is included in eChemPortal**  
* OECD Toolbox: Contains the data from the 2017 REACH database dump. With considerable amount of details (e.g. test item information in natural language. **Need to check this**.  
* LRI Ambit2: [link](http://cefic-lri.org/toolbox/ambit2/). Also contains the data from the 2017 REACH db. Has an API? and is developed by Ideaconsult (good sign for data accessibility). **Need to check this**.  
* IUCLID API with db dump: IUCLID6 provides a REST API. However it is very slow and inconvenient: information is coded, codes are available in the iuclid-data dcumentation, but not readily in machine-readable format. Also study records not directly accessible/searchable, but only via the study record UUIDs which in turn have to be requested first with the dossier UUID etc... not a viable solution for quickly getting the acute tox data. *(further info/experience on IUCLID api wanted)*  
* EPA chemistry dashboard: Has some acute tox data without much details and without references. Exports apparently only the presence of data, not the values itself?  
* HSDB via PubChem or directly  
* NIOSH-RTECS via PubChem or directly. Direct access to RTECS probably difficult
* tbc: there must be more

### Conclusion where to get data
eChemportal or OECD Toolbox seems to be the best solution for now.

## Use data from eChemPortal to get acute toxicity effect levels

### Usage of the eChemPortal propertysearch

eChemPortals property search [link](https://www.echemportal.org/echemportal/propertysearch/page.action?pageID=10) allows to search the REACH dissemination database (from 2017, as explained above). To get data one has to build query blocks (which have a different structure for the different endpoints) which specify the requested variables. For acute oral toxicity, the query offers the variables

* Type of information (the type of study {experimental, QSAR, read-accross, ...} where the information came from)
* Reliability (Klimisch Reliability scores)
* Reference, Year (Year of the study)
* Testguideline qualifier and guideline
* GLP compliance (not necessary for the current purpose)
* Test type (type of the study protocol {acute toxic class, up-and-down, ...})
* Species and Strain
* Route of administration
* Effect levels, Dose descriptor {approximate LD50, discriminating dose, LD0, LD100, LD50, LD50 cut-off, LDLo, other:}
* Effect levels, Effect level (the dose corresponding to the dose descriptor, specified by a quantifier amd the unit)
* Effect levels, Remarks on result (ignored)
* Interpretation of results (categorization according to GHS criteria, very useful in the current context)

There are two issues regarding the data export function
1. The fields are AND connected and fields with missing values lead to exclusion of the whole entry form the exported results. If a variable is left blank in the query, it is not included in the result.  
2. Exports are limited to 10000 observations (i.e. study results).

Both problems can be circumvented by creating various queries and joining the data by other means. The second is quite easily managable by splitting a queries in two year ranges. As every study report should have a reference year given, this should not lead to exclusion of studies. The first "just" needs an additional "layer" of distinct queries for every varibale that should be exported.
I'll be going for the minimal data needed for the purpose of getting experimental data to judge the classifications for acute toxicity: 
* type of information: needs to be experimental (i.e. no QSAR and read-accross studies)  
* reliability (only RL1 & RL2)
* Reference, year: left out if query results in less than 10000 results. else: 1990 is a good value to split the requests
* Effect level dose descriptors: all
* Effect level values: overlapping 0 - 9999 for each units. For each type of exposure, there is one corresponding unit (oral: mg/kg bw, dermal: mL/kg, inhalative: mg/m2)


### Processing the exported results from eChemPortal

#### for now only oral, tbc for inhal and dermal  
Each query was exported as one csv file.

```{r echemportal loading data}
files <- list.files(path ="data/echemportal/", pattern = "oral.*csv$", full.names = T)

studies_oral <- map(files, read_csv2) %>% bind_rows

studies_oral_clean <- studies_oral %>% 
  transmute(name = `Substance Name`,
            substance_number = `Substance Number`,
            number_type = `Number type`,
            link = `Substance Link`,
            route = str_extract(Section, "(?<=Acute toxicity: ).+"),
            reliability = str_extract(Values, "(?<=Reliability: )(\\d)"),
            descriptor = str_extract(Values, "(?<=Dose descriptor: ).+(?<!\\s)"),
            effect_level = str_extract(Values, "(?<=Effect level: ).+")
            )
```

```{r extract dose quantifier, dose and unit}
studies_oral_clean <- studies_oral_clean %>% 
  mutate(
    effect_level_quantifier = str_extract(effect_level, "^\\D+(?=\\s)"),
    effect_level_dose = str_extract(effect_level, "(\\d+)"),
    unit = str_extract(effect_level, "(?<=\\d\\s)\\D+$")
  )



studies_oral_clean %>%
  pull(number_type) %>%
  table
```
245 with EC number could be converted to CAS numbers. 2198 unknowns. What are these?
```{r look at unknowns and EC}
studies_oral_clean %>% 
  filter(str_detect(number_type, "EC|Unknown")) %>% 
  View
```
## Convert EC to CAS
### Any substances in the CLP list that have EC, but no CAS?

```{r check cas and EC in clp data}
clp_minimum %>% 
  filter(!is.na(ec) & is.na(cas)) %>% 
  View

```
yes, several. This should be fixed.

### Convert EC to CAS

Not possible directly via webchem (PubChem and CTS both don't support EC input).
Possibility is to use the EC inventory and do a lookup. However the EC invnetory export is limited to 20000 entires.
For this purpose the list of registered substances should be sufficient (currently little over 20000 entries, if only full registrations are exported, the lis is well within ECHAs download limit).

### Using ECHAs list of registered substances for the EC to CAS lookup

```{r}
echa_substances <- read_delim(file = "data/reg-substances-export.csv", delim = "\t", skip = 34)

# cleaning 
echa_substances <- echa_substances %>% 
  transmute(name_echa = Name,
            cas_echa = `Cas Number`,
            ec_echa = `EC / List Number`) %>% 
  distinct(ec_echa, .keep_all = TRUE) #needed because echa_substances contains duplicates from        
                                      #joint/individual submssions


# which are identified by EC Number
studies_oral_clean %>% 
  filter(str_detect(number_type, "EC")) %>% 
  View

# left_join

studies_oral_ec <- studies_oral_clean %>% 
  filter(str_detect(number_type, "EC")) %>% 
  left_join(echa_substances, by = c("substance_number" = "ec_echa")) %>% 
  mutate(cas_echa = ifelse(cas_echa == "-", NA, cas_echa)) %>% 
  filter(!is.na(cas_echa))



```

### Some for entries without any Number: trying to lookup using ECHAs list of registered substances by the name of the substances (likely to fail)

This is likely to fail, as these are probably substances without a CAS number anyways.
```{r name to cas}

studies_oral_name <- studies_oral_clean %>% 
  filter(str_detect(number_type, "Unknown") |
         (number_type == "EC" & !(name %in% studies_oral_ec$name))
         ) %>% 
  left_join(echa_substances, by = c("name" = "name_echa")) %>% 
  mutate(cas_echa = ifelse(cas_echa == "-", NA, cas_echa))


studies_oral_name %>% 
  filter(is.na(cas_echa) & is.na(ec_echa)) %>% 
  View
```

There shouldn't be any entries witout EC number actually because we're using ECHA disseminated data here. All entires should have at least an EC number.

```{r remove those with missing names and no identification via CAS No}
studies_oral_name <- 
  studies_oral_name %>% 
  mutate(name = ifelse(name == "-", NA, name)) %>%
  mutate(name = ifelse(str_detect(name, "unknown"), NA, name)) %>% 
  mutate(name = ifelse(str_detect(name, "unnamed"), NA, name)) %>% 
  filter(!(is.na(cas_echa) & is.na(name)))
```

ToDo: eChemPortal epxort appears to have a lot of missing names. Why is that? There also shouldn't be any exports from the REACH disseminated data without EC numbers. -> Check



## Combine the cleaned lists
I.e. the list with substances that can be identified by CAS + the list with CAS identifiers generated by EC numbers + the list with substances identified by their name.

### Step 1: For those with identification by EC No & succesful CAS No lookup: replace CAS by EC

```{r step 1 joining}
studies_oral_clean <- studies_oral_ec %>% 
  mutate(substance_number = cas_echa, 
         number_type = "CAS Number") %>% 
  bind_rows(studies_oral_clean %>%
              filter(number_type != "EC Number")
  )
```

### Step 2: For thse with no Ident. by EC nor by CAS, but succesful lookup by name: use name for comparison
```{r step 2 joining}
studies_oral_name %>% 
  mutate(number_type = "use_name") %>% 
  bind_rows(studies_oral_clean %>%
              filter(number_type != "Unknown")
  ) %>% 
  View # ToDo mistake here, now there are number_type = use_name which DO have a CAS No
      # needs to be split in step 2 + step 3: first use those obs where name lookup succeeded = step 2

```





## Try to derive CLP classification based on experimental data



### leftovers

Are there any study results without an EC number of substances that appear in the CLP list (identified by name)?

```{r}
(studies_oral_name %>% 
  filter(is.na(cas_echa) & is.na(ec_echa)) %>% 
  pull(name) %>%
  unique) %in% (clp_minimum %>% filter(str_detect(h_code, "H30\\d")) %>% 
  pull(substance)) # hazard codes with 30\d are the ones for acute oral toxicity
```

```{r echemportal deprecated}
clp_minimum %>%
  pull(cas) %>%
  write("export_for_epa_dashboard.txt")


read_csv("data/ChemistryDashboard-Batch-Search_2019-02-07_12_36_31.csv")
```
