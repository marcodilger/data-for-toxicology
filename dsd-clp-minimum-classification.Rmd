---
title: "Analysis of substances that are (mis)classified as less toxic as a result of the CLP Minimum classification (oral route)"
author: "Marco Dilger"
date: "April 12, 2019"
output:
  html_document:
    number_sections: true
    fig_caption: true
    theme: cerulean
bibliography: bibliography/data-supported-tox.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl) # reads xlsx without outer dependencies
library(plotly)
library(knitr)
```

# Identification of (mis)classified substances as a consequence of the CLP Minimum classification: application to oral toxicity using data frm eChemPortal.

## Background
Replacement of the dangerous substance directive (DSD) by the CLP regulation prompted major re-classification work to adhere to the new criteria. The old and new classification criteria fur acute toxicity don't match 100%. In case of ambiguity, the minimum classification concept prompts classification into the CLP category of lower toxicity (see image below for clarification). This ~~may~~ did lead to classifications which are not supported by the experimental data, which can be shown e.g. by the REACH registration data.

![Classification boundaries for DSD and CLP and the minimum classification. In this case the criteria for oral acute toxicity. For dermal and inhalative exposure, the concentration ranges where the minimum classification procedure leads to a "wrong" classification are wider for some category boundaries](img/dsd_to_clp_min_classification.svg)

## Get data with CLP classifications
ECHA provides (unofficial) tabular data of harmonized classifications [here](https://echa.europa.eu/information-on-chemicals/annex-vi-to-clp) in form of an excel file. The substances falling under the minimum classification are marked with an '*'.

Unfortunately it's only availabe as an excel file. The excel file contains text in the first 4 rows, the table headers in the next two rows, and the data starting with row 7. Parsing two rows as table headers is not suported by readxl::read_excel (don't know about xlsx::read.xlsx), but the [issue discussion](https://github.com/tidyverse/readxl/issues/486) on github provides a working solution. 

```{r get datam, echo = FALSE}

headers <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", range = cell_rows(5:6), col_names = FALSE) %>%
  map(na.omit) %>% 
  map(paste, collapse = "_") %>% 
  as.character

clp_table <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", skip = 6, col_names = headers)

```

```{r glimpse at clp table}
glimpse(clp_table)
```

Several variables look messy. For the purpose of this analysis we only need the hazard class categories, hazard codes and some id of the substances. Dropping anything else and renaming the vars:

```{r dropping uneccessary vars}
clp_table <- clp_table %>%
  transmute(
    substance = `International Chemical Identification`,
    ec = `EC No`,
    cas = `CAS No`,
    clp_class = `Classification_Hazard Class and Category Code(s)`,
    h_code = `Hazard Statement Code(s)`
  )
```


Further, multiple hazard categories are contained in 1 excel cell. This needs to be tidied up first.

```{r tidying df}
clp_table_tidy <- clp_table %>%
  separate_rows(clp_class, h_code, sep = "\r\n") %>%
  filter(str_length(clp_class) > 0)

clp_table_tidy %>% pull(clp_class) %>% 
  table %>% sort %>% 
  tail(20)
```
```{r export clp table}
write_csv(x = clp_table_tidy, path = "data/clp_table_atp10_20190214.csv")
```  
The cleaned CLP data (10th ATP) is exported to "data/clp_table_atp10_20190214.csv" for later re-use.

Selecting all observations, where the hazard class category contains acute tox and ends with '*'.

```{r extract minimum categorization}
clp_minimum <- clp_table_tidy %>%
  filter(str_detect(clp_class, "Acute.*\\*$")) # select all observations where the hazard class category contains acute tox and  ends with '*'

clp_minimum %>% 
  nrow

clp_minimum %>% 
  pull(substance) %>% 
  unique %>% 
  length
```
2511 minimum classifications distributed over 1576 substances.

## For how many of these substances does available data not support the classification?

### Sources of experimental data

* ECHA dissemination database: For the substances which are registered,cc this would certainly be the best source. Unfortunately, ECHA provides no API (subject to change) and it is a bit unclear whether scraping the webpage is allowed. (ECHA prohibits automated scraping of substantial amounts of data...but what is substantial?) 
* eChemportal: No API, but a batch search that should suffice for this purpose. Contains REACH data, but apparently that's only the 2017 database dump [(details here)](https://echa.europa.eu/-/data-on-15-000-chemicals-now-available-to-use), which would mean more recent data can't be found. I checked some registrations from 2018 manually and it seems the data are included until April or May 2018.  
* OECD Toolbox: Contains the data from the 2017 REACH database dump. With considerable amount of details (e.g. test item information in natural language. **Need to check this later**.  
* LRI Ambit2: [link](http://cefic-lri.org/toolbox/ambit2/). Also contains the data from the 2017 REACH db. Has an API? and is developed by Ideaconsult (good sign for data accessibility). **Need to check this later**.  
* IUCLID API with db dump: IUCLID6 provides a REST API. However it is very slow and inconvenient: information is coded, codes are available in the iuclid-data dcumentation, but not readily in machine-readable format. Also study records not directly accessible/searchable, but only via the study record UUIDs which in turn have to be requested first with the dossier UUID etc... not a viable solution for quickly getting the acute tox data. *(further info/experience on IUCLID api wanted)*  
* EPA chemistry dashboard: Has some acute tox data without much details and without references. Exports apparently only the presence of data, not the values itself? Also, some grave errors where apparent when looking at some examplary tox data, looked like they made some parsing mistake.  
* HSDB via PubChem or directly  
* NIOSH-RTECS via PubChem or directly. Direct access to RTECS probably difficult
* tbc: there must be more

### Conclusion where to get data
eChemPortal or OECD Toolbox seems to be the best solution for now. I'm going to use the eChemPortal for the oral route, and probably another data source later for dermal or inhalative toxicity.

## Use data from eChemPortal to get acute toxicity effect levels

### Usage of the eChemPortal property search

eChemPortals property search [link](https://www.echemportal.org/echemportal/propertysearch/page.action?pageID=10) allows to search the REACH dissemination database (from 2017, as explained above). To get data one has to build query blocks (which have a different structure for the different endpoints) which specify the requested variables. For acute oral toxicity, the query offers the variables

* Type of information (the type of study {experimental, QSAR, read-accross, ...} where the information came from)
* Reliability (Klimisch Reliability scores)
* Reference, Year (Year of the study)
* Testguideline qualifier and guideline
* GLP compliance (not necessary for the current purpose)
* Test type (type of the study protocol {acute toxic class, up-and-down, ...})
* Species and Strain
* Route of administration
* Effect levels, Dose descriptor {approximate LD50, discriminating dose, LD0, LD100, LD50, LD50 cut-off, LDLo, other:}
* Effect levels, Effect level (the dose corresponding to the dose descriptor, specified by a quantifier amd the unit)
* Effect levels, Remarks on result (ignored)
* Interpretation of results (categorization according to GHS criteria, very useful in the current context)

There are two issues regarding the data export function  

1. The query fields are AND connected and fields with missing values lead to exclusion of the whole entry form the exported results. If a variable is left blank in the query, it is not included in the result. For the most critical variables, this shouldn't be an issue, as an entry is required. But there is some information that can't be exported from eChemPortal due to this behaviour. (To reproduce the issue: query for all studies on acute oral toxicity older than 1950: 576 hits. If additionally the test guideline qualifier is queried, with all possible values selected, only 340 hits are returned)


2. Exports are limited to 10000 observations (i.e. study results).

The second problem can be circumvented by creating various queries and joining the data by other means. For example, in this case it is quite easily manageable by splitting a queries in two year ranges. As every study report should have a reference year given, this should not lead to exclusion of studies. For the first I don't know a good solution, but the impact is probably limited if the query is restricted to the most important variables. For this reason I'll be going for the minimal data needed for the purpose of getting experimental data to judge the classifications for acute toxicity:   

* type of information: needs to be experimental (i.e. no QSAR and read-accross studies)  
* reliability (only RL1 & RL2)  
* Reference, year: left out if query results in less than 10000 results. else: 1990 is a good value to split the requests  
* Effect level dose descriptors: all  
* Effect level values: overlapping 0 - 9999 for each units. For each type of exposure, there is one corresponding unit (oral: mg/kg bw, dermal: mL/kg, inhalative: mg/m²)  


### Processing the exported results from eChemPortal

For now, I'll focus on oral studies only, although the minimum classification probably has the least implications for this route. I'll deal with inhalation and dermal later, maybe with different methodology.  

Each query result from eChemPortal was exported as one csv file. Create one tibble of all csv files and create better variable name.

```{r echemportal loading data, message = FALSE}
files <- list.files(path ="data/echemportal/", pattern = "oral.*csv$", full.names = T)

studies_oral <- map(files, read_csv2) %>% bind_rows

studies_oral_clean <- studies_oral %>% 
  transmute(name = `Substance Name`,
            substance_number = `Substance Number`,
            number_type = `Number type`,
            link = `Endpoint Link`,
            route = str_extract(Section, "(?<=Acute toxicity: ).+"),
            reliability = str_extract(Values, "(?<=Reliability: )(\\d)"),
            effect_levels = str_extract(Values, "Effect levels(.|[:space:])*$")
  ) %>% 
  separate_rows(effect_levels, sep = "\\n\\r\\n\\r") %>% 
  mutate(
    descriptor = str_extract(effect_levels, "(?<=Dose descriptor: ).+(?<!\\s)"),
    effect_level = str_extract(effect_levels, "(?<=Effect level: ).+")
  ) %>% 
  select(-effect_levels)

```

Extract the effect concentrations, their quantifier, and the unit.  

```{r extract dose quantifier dose and unit}
studies_oral_clean <- studies_oral_clean %>% 
  mutate(
    effect_level_quantifier = str_extract(effect_level, "^\\D+(?=\\s)"),
    effect_level_dose = as.numeric(str_extract(effect_level, "(\\d+)")),
    unit = str_extract(effect_level, "(?<=\\d\\s)\\D+$")
  )
```
Keep only those with a suitable dose descriptor.

```{r keep LD50}
studies_oral_clean <- studies_oral_clean %>% 
  filter(str_detect(descriptor, "^LD50$|^approximate LD50$"))


studies_oral_clean %>%
  pull(number_type) %>%
  table
```

Those with EC number can be converted to CAS numbers or handled via EC number in case they have no CAS-RN. However, there are over 2000 unknowns. What are these?
```{r look at unknowns and EC}
studies_oral_clean %>% 
  filter(str_detect(number_type, "Unknown"))  %>% 
  select(name, substance_number) %>% 
  head(20)
```
Those with a name seem to be reaction masses. Those without a name seem to be primarily UVCBs and multi-constituent substances. Both are probably not too important for this analysis. However, they should all have an EC Number and it is unclear to me, why eChemPortal does not transport the substance number data.

Still, trying to clean up a bit...


## Convert EC to CAS
### Any substances in the CLP list that have EC, but no CAS?

```{r check cas and EC in clp data}
clp_minimum %>% 
  filter(!is.na(ec) & is.na(cas)) %>% 
  head

```
yes, several. This should be fixed.

### Convert EC to CAS

The webchem package [link to github](https://github.com/ropensci/webchem) is very nice for various conversions of chemical identifiers via CTS and PubChem. However EC -> CAS is not directly supported via PubChem or CTS as both don't support EC as input.
A possibility is to use the EC inventory and do a lookup. However the EC inventory export is limited to 20000 entires.
For this purpose the list of registered substances should be sufficient. It has currently little over 20000 entries, but if only full registrations are exported, the list is well within ECHAs download limit).

### Using ECHAs list of registered substances for the EC to CAS lookup

```{r}
echa_substances <- read_delim(file = "data/reg-substances-export.csv", delim = "\t", skip = 34)

# cleaning 
echa_substances <- echa_substances %>% 
  transmute(name_echa = Name,
            cas_echa = `Cas Number`,
            ec_echa = `EC / List Number`) %>% 
  distinct(ec_echa, .keep_all = TRUE) #needed because echa_substances contains duplicates from        
                                      #joint/individual submissions


# which are identified by EC Number
studies_oral_clean %>% 
  filter(str_detect(number_type, "EC"))

# left_join

studies_oral_ec <- studies_oral_clean %>% 
  filter(str_detect(number_type, "EC")) %>% 
  left_join(echa_substances, by = c("substance_number" = "ec_echa")) %>% 
  mutate(cas_echa = ifelse(cas_echa == "-", NA, cas_echa)) %>% 
  filter(!is.na(cas_echa))



```

### Same for entries without any Number: trying to lookup using ECHAs list of registered substances by the name of the substances (likely to fail)

This is likely to fail, as these are probably substances without a CAS number anyways.
```{r name to cas}

studies_oral_name <- studies_oral_clean %>% 
  filter(str_detect(number_type, "Unknown") |
         (number_type == "EC" & !(name %in% studies_oral_ec$name))
         ) %>% 
  left_join(echa_substances, by = c("name" = "name_echa")) %>% 
  mutate(cas_echa = ifelse(cas_echa == "-", NA, cas_echa))


studies_oral_name %>% 
  filter(is.na(cas_echa) & is.na(ec_echa))
```

There shouldn't be any entries witout EC number actually because we're using ECHA disseminated data here. All entries should have at least an EC number.

```{r remove those with missing names and no identification via CAS No}
studies_oral_name <- 
  studies_oral_name %>% 
  mutate(name = ifelse(name == "-", NA, name)) %>%
  mutate(name = ifelse(str_detect(name, "unknown|unnamed"), NA, name)) %>% 
  filter(!(is.na(cas_echa) & is.na(name)))
```


## Combine the cleaned lists
I.e. the list with substances that can be identified by CAS + the list with CAS identifiers generated by EC numbers + the list with substances identified by their name.

### Step 1: For those with identification by EC-Number & succesful CAS-Number lookup: replace EC by CAS

First replace EC by CAS in studies_oral_ec , then bind this to the part of studies_oral_clean that is not identified by EC-Number

```{r step 1 joining}
studies_oral_ec <- studies_oral_ec %>% 
  mutate(substance_number = cas_echa, 
         number_type = "CAS Number")

studies_oral_clean <- bind_rows(studies_oral_ec, studies_oral_clean %>%
              filter(number_type != "EC Number")
  )
```

### Step 2: For those with Identification by EC or by CAS after succesful name lookup: replace EC by CAS

First set substance number to CAS in studies_oral_name for all entries that have a CAS-Number, then bind this to the part of studies_oral_clean where number type is not "unknown".
```{r step 2 joining}
studies_oral_name <- studies_oral_name %>%
  filter(!is.na(cas_echa)) %>% 
  mutate(substance_number = cas_echa,
         number_type = "CAS Number")
  
  
studies_oral_clean <- bind_rows(studies_oral_name, studies_oral_clean %>%
              filter(number_type != "Unknown")
  ) 

```

### Step 3: For those with no Identification by EC nor by CAS after name lookup: use name getting classification

```{r step 3 joining}
studies_oral_clean <-
  studies_oral_name %>%
  filter(is.na(cas_echa)) %>%
  mutate(number_type = "use_name") %>%
  bind_rows(studies_oral_clean %>%
              filter(number_type != "Unknown") # redundant with current processing
            )
```
Adds some 160 entries. Probably not really worth it.


## Try to derive CLP classification based on experimental data

The classification limits for oral toxicity are:

| category | lower limit | upper limit |
|----------|-------------|-------------|
| 1        | NA          | 5           |
| 2        | 5           | 50          |
| 3        | 50          | 300         |
| 4        | 300         | 2000        |
| none     | 2000        | NA          |

```{r sequentially derive CLP classification from experimental data}
studies_oral_cat_derived <- studies_oral_clean %>% 
  #
  # handle not classified
  #
  mutate(category_from_exp = ifelse(is.na(effect_level_quantifier) & effect_level_dose > 2000, "not classified", NA),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                      str_detect(effect_level_quantifier, ">|ca") & # '=' doest not exist, in ths case the quantifier is na 
                                      effect_level_dose >= 2000, "not classified", category_from_exp)
         ) %>% 
  
  #
  # handle cat. 4
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) &
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose >= 300, 4, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                      str_detect(effect_level_quantifier, ">|ca") & # '=' doest not exist, in ths case the quantifier is na 
                                      effect_level_dose >= 300, 4, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                      str_detect(effect_level_quantifier, "<") &
                                      effect_level_dose > 300, 4, category_from_exp)
         ) %>% 
  #
  # handle cat 3
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) & 
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose >= 50, 3, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, ">|ca") & 
                                    effect_level_dose >= 50, 3, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, "<") & 
                                    effect_level_dose > 50, 3, category_from_exp)
         ) %>% 
   #
  # handle cat 2
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) & 
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose >= 5, 2, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, ">|ca") & 
                                    effect_level_dose >= 5, 2, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, "<") & 
                                    effect_level_dose > 5, 2, category_from_exp)
         ) %>% 
   #
  # handle cat 1
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) & 
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose < 5, 1, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, ">|ca") & 
                                    effect_level_dose < 5, 1, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, "<") & 
                                    effect_level_dose <= 5, 1, category_from_exp)
         )

```

Make sure that all are classified
```{r all classified}
studies_oral_cat_derived %>% 
  filter(is.na(category_from_exp)) %>% 
  nrow
```


```{r classification stats, dev = "png", dpi = 36, out.width = "50%", fig.asp = 1, fig.align = "center"}
studies_oral_cat_derived %>% 
  group_by(category_from_exp) %>% 
  tally %>% 
  ggplot(aes(x = category_from_exp, y = n)) +
  geom_bar(stat = "identity")

```  
  
## Combine harmonized classification with classification derived from experimental data

```{r combine harmonized with derived classification}

data_oral_combined_cas <- clp_minimum %>% 
  filter(str_detect(h_code, "H30\\d")) %>% # select only acute oral toxicity
  full_join(studies_oral_cat_derived %>% 
               select(name, substance_number, number_type, link, category_from_exp, reliability, effect_level_quantifier, effect_level_dose, unit) %>% 
               filter(number_type == "CAS Number"),
               by = c("cas" = "substance_number")
               )


data_oral_combined_name <- clp_minimum %>% 
  filter(str_detect(h_code, "H30\\d")) %>% # select only acute oral toxicity
  full_join(studies_oral_cat_derived %>% 
               select(name, substance_number, number_type, link, category_from_exp, reliability, effect_level_quantifier, effect_level_dose, unit) %>% 
               filter(number_type == "use_name"),
               by = c("substance" = "name")
               ) %>% 
  filter(!is.na(number_type))

data_oral_combined_name$substance %in% data_oral_combined_cas$substance %>% 
  table

``` 
Not a single study record of a substance that could not be identified by CAS/EC could be linked to the CLP table by the substance name. Still worth to check, this could be different for the other routes

```{r}
data_oral_combined_cas %>% 
  filter(is.na(cas) | cas == "-") %>% 
  nrow
```
very few left without CAS, going to ignore these.

```{r, dev = "png", out.width = "40%", fig.asp = 1.2, fig.align = "center"}
data_oral_combined <- data_oral_combined_cas %>% 
  filter(!is.na(cas) & cas != "-")

data_oral_combined %>% 
  group_by(cas) %>%
  summarise(has_experimental_data = any(!is.na(category_from_exp))) %>% 
  ggplot(aes(has_experimental_data)) +
  geom_bar()
```
  
Good news, most substances have experimental data.  

Occasionally several LD50 values are reported within the same study record. E.g. because the LD50 of (diluted) preparations/mixtures is reported as well or because there is a gender difference. The former is a problem for the analysis, the latter not. For the purpose of this analysis it is a viable solution to retain only the single lowest value from each study record. 

```{r}
data_oral_combined <- data_oral_combined %>% 
  filter(unit == "mg/kg bw") %>% 
  group_by(link) %>% # link can be used for grouping 
  filter(effect_level_dose == min(effect_level_dose)) %>% 
  distinct(effect_level_dose, .keep_all = TRUE) %>% 
  ungroup

```

### Visualization of derived category from every study with a LD50 value

```{r, dev = "png", fig.align = "center", out.width = "60%"}
data_oral_combined %>% 
  filter(!is.na(clp_class)) %>% #remove all without harmoized classif.
  ggplot(aes(x = factor(clp_class), y = category_from_exp)) +
  geom_jitter()
```

```{r, dev = "png", fig.align = "center", out.width = "60%"}
data_oral_combined %>% 
  filter(!is.na(clp_class)) %>% #remove all without harmonized classif.
  filter(!is.na(category_from_exp) | category_from_exp != "not classified") %>% #remove all studies with no classification from experimental studies
  group_by(cas) %>% 
  summarize(single_category = mean(as.numeric(str_replace(category_from_exp, "not classified", "5")), na.rm = TRUE), #na.rm = TRUE is redundant; not classified treated as numerical value of 5
            clp_class = tail(names(sort(table(clp_class))), 1),
            n_experiment = sum(!is.na(category_from_exp))
            ) %>% 
 ggplot(aes(x = factor(clp_class), y = single_category, size = n_experiment)) +
  geom_point(alpha = 0.5, position = position_jitter())
```  

Already obvious that there is a high amount of substances which can quite reliably be classified to a more strict category than according to the minimum classification. Nearly all of these substances would "jump" 1 category, however there are some currently classified as "Acute Tox 4 *" which would probably jump to cat. 2 (indicated by several experimental studies with a mean LD50 < 3).

Identifiying these candidates for concern by a constructed variable:

```{r, dev = "png", fig.align = "center", out.width = "60%"}
data_oral_grouped <- data_oral_combined %>% 
  filter(!is.na(clp_class)) %>% #remove all without harmonized classif.
  filter(!is.na(category_from_exp) | category_from_exp != "not classified") %>% #remove all studies with no classification from experimental studies
  group_by(cas) %>% 
  summarize(single_category = mean(as.numeric(str_replace(category_from_exp, "not classified", "5")), na.rm = TRUE), #na.rm = TRUE is redundant; not classified treated as numerical value of 5
            clp_class = tail(names(sort(table(clp_class))), 1),
            n_experiment = sum(!is.na(category_from_exp))
            ) %>% 
  # concern = 2 for experimental data which deviate > 1 from current classification
  # concern = 1                                     < 1 > 0
  # concern = 0 else
  mutate(numeric_clp_class = as.numeric(str_extract(clp_class, "\\d")), #treat not classified as numerical value 5
         concern = ifelse(single_category < numeric_clp_class - 1, 2, 
                         ifelse(single_category < numeric_clp_class, 1, 0)
                          )
         )

# plot
data_oral_grouped %>% 
  ggplot(aes(x = factor(clp_class), y = single_category, size = n_experiment, color = factor(concern))) +
  geom_point(alpha = 0.4, position = position_jitter())
```

### Closer look at those with concern > 1

Extend the data on single experiments with the derived info from grouping by substances and plot substances of high concern

```{r}
data_oral_extended <- data_oral_combined %>% 
  inner_join(data_oral_grouped, by = c("cas", "clp_class"))

```

Aligned dot plot for visualization, amount of studies as dot size:

```{r substances_of_concern_plot, out.width = "100%", fig.asp = 0.5, dev = "png", fig.align = "center"}
plot_substances_of_concern <- data_oral_extended %>% 
  filter(concern >= 1) %>% 
  arrange(single_category) %>% 
  ggplot(aes(x = fct_reorder(substance, single_category, min), y = category_from_exp)) + # fct_reorder to order factor from lowest single_category to highest
  geom_count(aes(size = ..n..,
                 colour = as.factor(numeric_clp_class))) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(label = function(x) substring(x, 1, 20)) +
  theme(legend.text=element_text(size=rel(0.8))) + # smaller legend font, to give more space to the plot 
  labs(colour = "original\nclassification",
       size = "amount\nof studies") +
  theme(legend.position = "bottom", legend.box.just = "center") +
  ylab("Category derived\nfrom experimental data") + 
  xlab("Substance")

plot_substances_of_concern

```  



### Interactive visualization and comparison with registration dossiers

```{r out.width = "100%"}

plot_substances_of_concern_plotly <- data_oral_extended %>% 
  filter(concern >= 1) %>% 
#  arrange(single_category) %>% 
  group_by(substance, category_from_exp) %>% 
  mutate(
    plot_label = paste(paste(ifelse(is.na(effect_level_quantifier), "  ", effect_level_quantifier)
                              , effect_level_dose, unit, "- reliability:", reliability, sep = " "),
                        sep = "", collapse = "\n")
  ) %>% 
  ggplot(aes(x = fct_reorder(substance, single_category, min), y = category_from_exp, colour = as.factor(numeric_clp_class), label = plot_label))  + # fct_reorder to order factor from lowest single_category to highest
  geom_count() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(label = function(x) substring(x, 1, 20)) +
  labs(colour = "original\nclassification",
       size = "amount\nof studies") +
  theme(legend.position = "bottom") +
  ylab("Category derived\nfrom experimental data") + 
  xlab("Substance")
  

ggplotly(plot_substances_of_concern_plotly,
         tooltip = c("label")) %>% # instead of "all"
  layout(legend = list(orientation = "h",
                       y = -.8))  # ToDo: does not show both legends,  problem between ggplot output -> plotly


``` 
  
## Comparing the substances with concern > 1 with registration data

```{r}
data_oral_extended %>% 
  filter(concern >= 2) %>% 
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```
Only 2 substances with a numerical difference > 2 between current CLH and classification derived from experimental data. For epoxybutane, only 2 experimental values and the difference in the effective dose is huge! Suspicion: there are some entries where the unit is not the same, thus severe differences in effect levels.
```{r}
data_oral_extended %>% 
  pull(unit) %>% 
  table
```
Nope. Closer look at epoxybutane and peracetic acid:


### 1,2-epoxybutane  
Interesting case, eChemportal exported 2 studies with same reliability but tremendous difference in the effect level concentration relevant for classification. Looking at the dossier [https://echa.europa.eu/registration-dossier/-/registered-dossier/13837//?documentUUID=7f00ec16-d9ee-4ab2-b8a9-35fd844a73e5](link) shows there are actually 4 studies with RL 1 or 2, although only 2 can be found in eChemPortal (could be because cChemPortal is lagging a bit behind with getting data from ECHA and these studies were added to the ECHA database since the last eChemPortal update). Also the UUIDs seem to have changed.  
The reason for the big difference in the effect level concentration is actually mistake in the dossier: LD50 is reported as 1 mg/kg bw, but is 1 g/kg bw (obvious when looking at the freetext field "mortality").
Great start...first substance and already a mistake in the registration dossier and only 2/4 available studies covered by the experimental data set.


### peracetic acid

Huge number of studies indicating category 2 & 3, several RL1. UUIDs also don't match for this substance. Interesting case as well, as there are several LD50 of formulations reported (with consequently considerably higher LD50 values than the neat substance). Filtering out these values by only keeping th ellowest seems to work reasonably well.
Overall the classification as Category 2 seems to be very well justified based on the experimental data.


## Comparing some of the substances with concern = 1 to the registration data
```{r getting links to dossiers concern 1}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability) %>% 
  pull(substance) %>% 
  unique
```
Many important substances in this list. looking at some examples.

### Hydrogen Cyanide

```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "(?i)hydrogen\\scyanide")) %>% 
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```


There is experimental data from 2 studies. Both values quite clearly indicate cat. 1 instead of 2, the current CLH category. The registation data confirms these values (with a "creative" way of reporting effect concentration). Looks like HCN is currently not appropriately classified in the CLP.


### Acrylonitrile
```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "(?i)acrylonitrile")) %>%
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```
2 experimental values exported from eChemportal. Same reliability, first study corresponds to cat. 3, second study to cat. 2. These values fit the reported data in the ECHA database. The second value (indicating category 2 instead of 3), in this case corresponds to the lowest value of actually several studies given for this study in the ECHA data (as results from several studies are reported within in the same endpoint study record - certainly not ideal). Further, according to the result description, these results are from studies with different quality and the most reliable value is actually not the 25 mg/kg bw, but a higher one. Thus, category 3 seems justified.

### chromium (VI) trioxide

```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "(?i)chromium.*trioxide")) %>%
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```
1 RL 1 study indicating category 3. 3 RL2 studies with values indicating cat 2/3. Current CLH: category 3. Reporting in the dossier is again not ideal for automated processing: for one study record, the reported effect levels correspond to several chromates, and without processing the natural language it is not possible to determine which is the one for chromium (VI) oxide. Overall, this seems like a false alarm and cat. 3 is justified.

### Nickel sulfate

```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "(?i)nickel\\ssulfate")) %>%
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```
Two experimental values from eChemportal. Fits the dossier, the first value is from a modern guideline study. The second is also from a quite reliable source and it's lowest LD50 value is just below the lower limit for cat. 4. CLH cat 4 seems justified, although a conservative approach could lead to 3.

### Vanadiumpentoxide

```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "(?i)vanadium\\spentoxide")) %>%
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```
I took V~2~O~5~ in because at the time of this writeup, a CLH dossier was just submitted by France, so I can directly compare with an elaborated and recent opinion: [https://echa.europa.eu/de/registry-of-clh-intentions-until-outcome/-/dislist/details/0b0236e1814e26d1](Link). France proposes oral toxicity cat. 3 (and btw a stricter classification for CMR properties). The CLH report is not yet available.
The dossier lists 3 high quality studies, which lowests results were correctly processed in this analysis. They are all from different test materials but from the same lab with the same protocol, so should be directly comparable. The lowest value comes from technical grade V~2~O~5~. Certainly this result was chosen as the critical one for classification, so that the CLH appropriately covers diverse qualities of V~2~O~5~. 

### Ethylacrylate

```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "(?i)^ethyl.*acrylate")) %>%
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, single_category, link) %>% 
  arrange(single_category, substance, reliability)
```
I wanted to take a closer look at Ethylacrylate because of the high number of reliable studies available. 10 experimental results with RL2 exported from eChemportal. I didn't compare all results to the dossier, but it looks like all values are correctly exported. However some of the studies are quite old and it some have very little study details reported and sometimes low animal numbers... probably not all of the 10 studies should be considered equal in reliability.
Regarding the classification it seems like those lower values are from exactly those studies which seem to have a lower reliability, so the current CLH with cat. 4 is likely appropriate even though 2 studies indicate 3. But this might need a closer look.

# Conclusion

## Suitability of eChemPortal as a data source for acute toxicity

* data export from eChemportal is quite labour intensive for larger/untargeted datasets. There is no API available and the amount of returned results is limited, leading to the necessity to create several data queries. Every variable that needs to be exported has to be queried specificially with a target value. This means that for any categorical variable several query blocks have to be constructed, one for each category of interest. Overall, retrieving the data from eChemPortal is possible, but there are hurdles. 
* I did not encounter any mistakes in the data. This is expected, as eChemPortal uses structured IUCLID data from ECHA.
    * However, it seems EC Numbers are missing sometimes. No idea why.
* The data in eChemPortal is not up to date with the ECHA database. It looks like more recent data than the 2017 IUCLID database dump is found, but registrations or updates after April or May 2018 seem to be missing. For assessing the appropriateness of the minimum classification this is, at most, only a minor drawback.

## Using experimental data to flag inappropriate minimum classifications

* The core idea of this analysis was to use experimental data from registration dossiers to identify substances where the minimum classification does not fit the actual data available. For the data on oral toxicity this worked reasonably well, but there are exeptions.
* However, there seems to be quite a number of false positives, as is revealed when looking closer at the data: substances are flagged as having an inappropriate CLH classifiation even though it actually fits the data. The criteria I choose in this analysis (i.e. always selecting the lowest value within on endpoint study record) aim for a conservative result, prefering some false positives over not catching some real positives. Further improving the accuracy is limited by the data structure in the disseminated registration data and would probably involve natural language processing of the free text fields (which probably? (ToDo: check)) are anyways not included in the eChemPortal data.

## Validation of the hits by comparison with other sources  

* I manually checked some of the hits. To avoid manual checking, a comparison with the self classification of the registrants is probably very helpful. Actually N. Neuwirth & J. Püringer from the austrian AUVA used this method to identify inappropriate minimum classifications to begin with [@neuwirth2016clp]. Registrants are obliged to report a "correct" self classification if they have data that does not agree with the minimum classification.  I will probably follow up on this later on and compare the two methods or validate the hits.

## List of results
The following list contains all the substances that were flagged as having an inappropriate (minimum) classification, without correcting for the detected false positives.

```{r conclusion list of results}
data_oral_extended %>% 
  filter(concern >= 1) %>%
  select(substance, cas, numeric_clp_class, single_category) %>%   
  group_by(substance, cas) %>% 
  summarize(
    category_minimum = unique(numeric_clp_class),
    category_experimental = floor(unique(single_category))
    ) %>% 
  arrange(category_experimental, substance) %>% 
  kable

```




# Sessioninfo 

```{r sessioninfo}
devtools::session_info()
```
# References
