---
title: "CLP Minimum classifications"
author: "Marco Dilger"
date: "February 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl) # reads xlsx without outer dependencies
library(plotly)
```

## Analysis of substances that are (mis)classified as less toxic as a result of the CLP Minimum classification

### Background
Replacement of the dangerous substance directive (DSD) by the CLP regulation prompted major re-classification work to adhere to the new criteria. The old and new classification criteria fur acute toxicity don't match 100%. In case of ambiguity, the minimum classification concept prompts classification into the CLP category of lower toxicity (*this needs a figure for explanation*)). This \~\~may\~\~did lead to classifications which are not supported by the experimental data, which can be shown e.g. by the REACH registration data.

### Get data with CLP classifications
ECHA provides (unofficial) tabular data of harmonized classifications [here](https://echa.europa.eu/information-on-chemicals/annex-vi-to-clp) in form of an excel file. The substances falling under the minimum classification are marked with an '*'.

Unfortunately it's only availabe as an excel file. The excel file contains text in the first 4 rows, the table headers in the next two rows, and the data starting with row 7. Parsing two rows as table headers is not suported by readxl::read_excel (don't know about xlsx::read.xlsx), but the [issue discussion](https://github.com/tidyverse/readxl/issues/486) on github provides a working solution. 

```{r get data}

headers <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", range = cell_rows(5:6), col_names = FALSE) %>%
  map(na.omit) %>% 
  map(paste, collapse = "_") %>% 
  as.character

clp_table <- read_excel("data/annex_vi_clp_table_atp10_en.xlsx", skip = 6, col_names = headers)
# ToDo: look into option .name_repair

glimpse(clp_table)
```
Many variables look messy. For the purpose of this analysis we only need the hazard class categories and some id of the substances. Dropping anything else and renaming the vars:

```{r dropping uneccessary vars}
clp_table <- clp_table %>%
  transmute(
    substance = `International Chemical Identification`,
    ec = `EC No`,
    cas = `CAS No`,
    clp_class = `Classification_Hazard Class and Category Code(s)`,
    h_code = `Hazard Statement Code(s)`
  )
```


As expected, multiple hazard categories are contained in 1 excel cell. This needs to be tidied up first.
```{r tidying df}
clp_table_tidy <- clp_table %>%
  separate_rows(clp_class, h_code, sep = "\r\n") %>%
  filter(str_length(clp_class) > 0)

clp_table_tidy %>% pull(clp_class) %>% 
  table %>% sort %>% 
  tail(20)
```
```{r export clp table}
write_csv(x = clp_table_tidy, path = "data/clp_table_atp10_20190214.csv")
```  
The cleaned CLP data (10th ATP) is exported to "data/clp_table_atp10_20190214.csv".

```{r extract minimum categorization}
clp_minimum <- clp_table_tidy %>%
  filter(str_detect(clp_class, "Acute.*\\*$")) # select all observations where the hazard class category contains acute tox and  ends with '*'
```
2845 substances

## For how many of these substances does available data not support the classification?

### Sources of experimental data

* ECHA dissemination database: For the substances which are registered,cc this would certainly be the best source. Unfortunately, ECHA provides no API (subject to change) and it is a bit unclear whether scraping the webpage is allowed. (ECHA prohibits automated scraping of substantial amounts of data...but what is substantial?) 
* eChemportal: No API, but a batch search that should suffice for this purpose. Contains REACH data, but apparently that's only the 2017 database dump [(details here)](https://echa.europa.eu/-/data-on-15-000-chemicals-now-available-to-use), which would mean more recent data can't be found. **ToDo later: check if data from a post-2017 registration is included in eChemPortal**  
* OECD Toolbox: Contains the data from the 2017 REACH database dump. With considerable amount of details (e.g. test item information in natural language. **Need to check this**.  
* LRI Ambit2: [link](http://cefic-lri.org/toolbox/ambit2/). Also contains the data from the 2017 REACH db. Has an API? and is developed by Ideaconsult (good sign for data accessibility). **Need to check this**.  
* IUCLID API with db dump: IUCLID6 provides a REST API. However it is very slow and inconvenient: information is coded, codes are available in the iuclid-data dcumentation, but not readily in machine-readable format. Also study records not directly accessible/searchable, but only via the study record UUIDs which in turn have to be requested first with the dossier UUID etc... not a viable solution for quickly getting the acute tox data. *(further info/experience on IUCLID api wanted)*  
* EPA chemistry dashboard: Has some acute tox data without much details and without references. Exports apparently only the presence of data, not the values itself?  
* HSDB via PubChem or directly  
* NIOSH-RTECS via PubChem or directly. Direct access to RTECS probably difficult
* tbc: there must be more

### Conclusion where to get data
eChemportal or OECD Toolbox seems to be the best solution for now.

## Use data from eChemPortal to get acute toxicity effect levels

### Usage of the eChemPortal propertysearch

eChemPortals property search [link](https://www.echemportal.org/echemportal/propertysearch/page.action?pageID=10) allows to search the REACH dissemination database (from 2017, as explained above). To get data one has to build query blocks (which have a different structure for the different endpoints) which specify the requested variables. For acute oral toxicity, the query offers the variables

* Type of information (the type of study {experimental, QSAR, read-accross, ...} where the information came from)
* Reliability (Klimisch Reliability scores)
* Reference, Year (Year of the study)
* Testguideline qualifier and guideline
* GLP compliance (not necessary for the current purpose)
* Test type (type of the study protocol {acute toxic class, up-and-down, ...})
* Species and Strain
* Route of administration
* Effect levels, Dose descriptor {approximate LD50, discriminating dose, LD0, LD100, LD50, LD50 cut-off, LDLo, other:}
* Effect levels, Effect level (the dose corresponding to the dose descriptor, specified by a quantifier amd the unit)
* Effect levels, Remarks on result (ignored)
* Interpretation of results (categorization according to GHS criteria, very useful in the current context)

There are two issues regarding the data export function
1. The fields are AND connected and fields with missing values lead to exclusion of the whole entry form the exported results. If a variable is left blank in the query, it is not included in the result.  
2. Exports are limited to 10000 observations (i.e. study results).

Both problems can be circumvented by creating various queries and joining the data by other means. The second is quite easily managable by splitting a queries in two year ranges. As every study report should have a reference year given, this should not lead to exclusion of studies. The first "just" needs an additional "layer" of distinct queries for every varibale that should be exported.
I'll be going for the minimal data needed for the purpose of getting experimental data to judge the classifications for acute toxicity: 
* type of information: needs to be experimental (i.e. no QSAR and read-accross studies)  
* reliability (only RL1 & RL2)
* Reference, year: left out if query results in less than 10000 results. else: 1990 is a good value to split the requests
* Effect level dose descriptors: all
* Effect level values: overlapping 0 - 9999 for each units. For each type of exposure, there is one corresponding unit (oral: mg/kg bw, dermal: mL/kg, inhalative: mg/m2)


### Processing the exported results from eChemPortal

#### for now only oral, tbc for inhal and dermal  
Each query was exported as one csv file. Create one tibble of all csv files and create better variable name.

```{r echemportal loading data}
files <- list.files(path ="data/echemportal/", pattern = "oral.*csv$", full.names = T)

studies_oral <- map(files, read_csv2) %>% bind_rows

studies_oral_clean <- studies_oral %>% 
  transmute(name = `Substance Name`,
            substance_number = `Substance Number`,
            number_type = `Number type`,
            link = `Endpoint Link`,
            route = str_extract(Section, "(?<=Acute toxicity: ).+"),
            reliability = str_extract(Values, "(?<=Reliability: )(\\d)"),
            effect_levels = str_extract(Values, "Effect levels(.|[:space:])*$")
  ) %>% 
  separate_rows(effect_levels, sep = "\\n\\r\\n\\r") %>% 
  mutate(
    descriptor = str_extract(effect_levels, "(?<=Dose descriptor: ).+(?<!\\s)"),
    effect_level = str_extract(effect_levels, "(?<=Effect level: ).+")
  ) %>% 
  select(-effect_levels)

```

Extract the effect concentrations, their quantifier, and the unit  

```{r extract dose quantifier, dose and unit}
studies_oral_clean <- studies_oral_clean %>% 
  mutate(
    effect_level_quantifier = str_extract(effect_level, "^\\D+(?=\\s)"),
    effect_level_dose = as.numeric(str_extract(effect_level, "(\\d+)")),
    unit = str_extract(effect_level, "(?<=\\d\\s)\\D+$")
  )
```
Keep only those with a suitable dose descriptor

```{r}
studies_oral_clean <- studies_oral_clean %>% 
  filter(str_detect(descriptor, "^LD50$|^approximate LD50$"))


studies_oral_clean %>%
  pull(number_type) %>%
  table
```

Those with EC number can be converted to CAS numbers or handled via EC number in case they have no CAS-RN. However, there are over 2000 unknowns. What are these?
```{r look at unknowns and EC}
studies_oral_clean %>% 
  filter(str_detect(number_type, "Unknown")) %>% 
  head(20)
```
Those with a name seem to be reaction masses. Those without a name seem to be primarily UVCBs and multi-constituent substances. Both are probably not too important for this analysis. However, they should all have an EC Number and it is unclear to me, why eChemPortal does not transport the substance number data.

Still, trying to clean uo a bit...

## Convert EC to CAS
### Any substances in the CLP list that have EC, but no CAS?

```{r check cas and EC in clp data}
clp_minimum %>% 
  filter(!is.na(ec) & is.na(cas)) %>% 
  head

```
yes, several. This should be fixed.

### Convert EC to CAS

The webchem package [https://github.com/ropensci/webchem]((link to github)) is very nice for various conversions of chemical identifiers via CTS and PubChem. However EC-> CAS is not directly via PubChem or CTS as both don't support EC as input.
A possibility is to use the EC inventory and do a lookup. However the EC inventory export is limited to 20000 entires.
For this purpose the list of registered substances should be sufficient. It has currently little over 20000 entries, but if only full registrations are exported, the list is well within ECHAs download limit).

### Using ECHAs list of registered substances for the EC to CAS lookup

```{r}
echa_substances <- read_delim(file = "data/reg-substances-export.csv", delim = "\t", skip = 34)

# cleaning 
echa_substances <- echa_substances %>% 
  transmute(name_echa = Name,
            cas_echa = `Cas Number`,
            ec_echa = `EC / List Number`) %>% 
  distinct(ec_echa, .keep_all = TRUE) #needed because echa_substances contains duplicates from        
                                      #joint/individual submssions


# which are identified by EC Number
studies_oral_clean %>% 
  filter(str_detect(number_type, "EC"))

# left_join

studies_oral_ec <- studies_oral_clean %>% 
  filter(str_detect(number_type, "EC")) %>% 
  left_join(echa_substances, by = c("substance_number" = "ec_echa")) %>% 
  mutate(cas_echa = ifelse(cas_echa == "-", NA, cas_echa)) %>% 
  filter(!is.na(cas_echa))



```

### Same for entries without any Number: trying to lookup using ECHAs list of registered substances by the name of the substances (likely to fail)

This is likely to fail, as these are probably substances without a CAS number anyways.
```{r name to cas}

studies_oral_name <- studies_oral_clean %>% 
  filter(str_detect(number_type, "Unknown") |
         (number_type == "EC" & !(name %in% studies_oral_ec$name))
         ) %>% 
  left_join(echa_substances, by = c("name" = "name_echa")) %>% 
  mutate(cas_echa = ifelse(cas_echa == "-", NA, cas_echa))


studies_oral_name %>% 
  filter(is.na(cas_echa) & is.na(ec_echa))
```

There shouldn't be any entries witout EC number actually because we're using ECHA disseminated data here. All entries should have at least an EC number.

```{r remove those with missing names and no identification via CAS No}
studies_oral_name <- 
  studies_oral_name %>% 
  mutate(name = ifelse(name == "-", NA, name)) %>%
  mutate(name = ifelse(str_detect(name, "unknown"), NA, name)) %>% 
  mutate(name = ifelse(str_detect(name, "unnamed"), NA, name)) %>% 
  filter(!(is.na(cas_echa) & is.na(name)))
```


## Combine the cleaned lists
I.e. the list with substances that can be identified by CAS + the list with CAS identifiers generated by EC numbers + the list with substances identified by their name.

### Step 1: For those with identification by EC No & succesful CAS No lookup: replace CAS by EC

```{r step 1 joining}
studies_oral_clean <- studies_oral_ec %>% 
  mutate(substance_number = cas_echa, 
         number_type = "CAS Number") %>% 
  bind_rows(studies_oral_clean %>%
              filter(number_type != "EC Number")
  )
```

### Step 2: For those with Ident. by EC or by CAS after succesful name lookup: replace CAS by EC
```{r step 2 joining}
studies_oral_clean <- studies_oral_name %>%
  filter(!is.na(cas_echa)) %>% 
  mutate(substance_number = cas_echa,
         number_type = "CAS Number") %>% 
  bind_rows(studies_oral_clean %>%
              filter(number_type != "Unknown")
  ) 

```

### Step 3: For those with no Ident. by EC nor by CAS after name lookup: use name getting classification

```{r step 3 joining}
studies_oral_clean <-
  studies_oral_name %>%
  filter(is.na(cas_echa)) %>%
  mutate(number_type = "use_name") %>%
  bind_rows(studies_oral_clean %>%
              filter(number_type != "Unknown") # redundant with current processing
            )
```
Adds some 160 entries. Probably not really worth it.


## Try to derive CLP classification based on experimental data

The classification limits for oral toxicity are:

| category | lower limit | upper limit |
|----------|-------------|-------------|
| 1        | NA          | 5           |
| 2        | 5           | 50          |
| 3        | 50          | 300         |
| 4        | 300         | 2000        |
| none     | 2000        | NA          |

```{r sequentially derive CLP classification from experimental data}
studies_oral_cat_derived <- studies_oral_clean %>% 
  #
  # handle not classified
  #
  mutate(category_from_exp = ifelse(is.na(effect_level_quantifier) & effect_level_dose > 2000, "not classified", NA),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                      str_detect(effect_level_quantifier, ">|ca") & # '=' doest not exist, in ths case the quantifier is na 
                                      effect_level_dose >= 2000, "not classified", category_from_exp)
         ) %>% 
  
  #
  # handle cat. 4
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) &
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose >= 300, 4, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                      str_detect(effect_level_quantifier, ">|ca") & # '=' doest not exist, in ths case the quantifier is na 
                                      effect_level_dose >= 300, 4, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                      str_detect(effect_level_quantifier, "<") &
                                      effect_level_dose > 300, 4, category_from_exp)
         ) %>% 
  #
  # handle cat 3
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) & 
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose >= 50, 3, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, ">|ca") & 
                                    effect_level_dose >= 50, 3, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, "<") & 
                                    effect_level_dose > 50, 3, category_from_exp)
         ) %>% 
   #
  # handle cat 2
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) & 
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose >= 5, 2, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, ">|ca") & 
                                    effect_level_dose >= 5, 2, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, "<") & 
                                    effect_level_dose > 5, 2, category_from_exp)
         ) %>% 
   #
  # handle cat 1
  #
  mutate(category_from_exp = ifelse(is.na(category_from_exp) & 
                                    is.na(effect_level_quantifier) &
                                    effect_level_dose < 5, 1, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, ">|ca") & 
                                    effect_level_dose < 5, 1, category_from_exp),
         category_from_exp = ifelse(is.na(category_from_exp) & 
                                    str_detect(effect_level_quantifier, "<") & 
                                    effect_level_dose <= 5, 3, category_from_exp)
         )

# check if all are classified

studies_oral_cat_derived %>% 
  filter(is.na(category_from_exp)) %>% 
  nrow

```
All classified

```{r classification stats}
studies_oral_cat_derived %>% 
  group_by(category_from_exp) %>% 
  tally %>% 
  ggplot(aes(x = category_from_exp, y = n)) +
  geom_bar(stat = "identity")

```  
  
## Combine harmonized classification with classification derived from experimental data

```{r combine harmonized with derived classification}

data_oral_combined_cas <- clp_minimum %>% 
  filter(str_detect(h_code, "H30\\d")) %>% # select only acute oral toxicity
  full_join(studies_oral_cat_derived %>% 
               select(name, substance_number, number_type, link, category_from_exp, reliability, effect_level_quantifier, effect_level_dose, unit) %>% 
               filter(number_type == "CAS Number"),
               by = c("cas" = "substance_number")
               )


data_oral_combined_name <- clp_minimum %>% 
  filter(str_detect(h_code, "H30\\d")) %>% # select only acute oral toxicity
  full_join(studies_oral_cat_derived %>% 
               select(name, substance_number, number_type, link, category_from_exp, reliability, effect_level_quantifier, effect_level_dose, unit) %>% 
               filter(number_type == "use_name"),
               by = c("substance" = "name")
               ) %>% 
  filter(!is.na(number_type))

data_oral_combined_name$substance %in% data_oral_combined_cas$substance %>% 
  table

``` 
Not a single study record of a substance that could not be identified by CAS/EC could be linked to the CLP table by the substance name. Still worth to check, this could be different for the other routes

```{r}
data_oral_combined_cas %>% 
  filter(is.na(cas) | cas == "-") %>% 
  nrow
```
very few left without CAS, going to ignore these.

```{r}
data_oral_combined <- data_oral_combined_cas %>% 
  filter(!is.na(cas) & cas != "-")

data_oral_combined %>% 
  group_by(cas) %>%
  summarise(has_experimental_data = any(!is.na(category_from_exp))) %>% 
  ggplot(aes(has_experimental_data)) +
  geom_bar()
```
  
Good news, most substances have experimental data.  

Occasionally several LD50 values are reported within the same study record. E.g. because the LD50 of (diluted) preparations/mixtures is reported as well or because there is a gender difference. The former is a problem for the analysis, the latter not. For the purpose of this analysis it is a viable solution to retain only the single lowest value from each study record. 

```{r}
data_oral_combined <- data_oral_combined %>% 
  filter(unit == "mg/kg bw") %>% 
  group_by(link) %>% # link can be used for grouping 
  mutate(min_effect_level_dose = min(effect_level_dose)) %>% 
  filter(effect_level_dose == min_effect_level_dose) %>% 
  select(-min_effect_level_dose) %>% 
  ungroup

```

### Visualization of derived category from every study with a LD50 value

```{r}
data_oral_combined %>% 
  filter(!is.na(clp_class)) %>% #remove all without harmoized classif.
  ggplot(aes(x = factor(clp_class), y = category_from_exp)) +
  geom_jitter()
```
```{r}
data_oral_combined %>% 
  filter(!is.na(clp_class)) %>% #remove all without harmonized classif.
  filter(!is.na(category_from_exp) | category_from_exp != "not classified") %>% #remove all studies with no classification from experimental studies
  group_by(cas) %>% 
  summarize(single_category = mean(as.numeric(str_replace(category_from_exp, "not classified", "5")), na.rm = TRUE), #na.rm = TRUE is redundant; not classified treated as numerical value of 5
            clp_class = tail(names(sort(table(clp_class))), 1),
            n_experiment = sum(!is.na(category_from_exp))
            ) %>% 
 ggplot(aes(x = factor(clp_class), y = single_category, size = n_experiment)) +
  geom_point(alpha = 0.5, position = position_jitter())
```  

Already obvious that there is a high amount of substances which can quite reliably be classified to a more strict category than according to the minimum classification. Nearly all of these substances would "jump" 1 category, however there are some currently classified as "Acute Tox 4 *" which would probably jump to cat. 2 (indicated by several experimental studies with a mean LD50 < 3).

Identifiying these candidates for concern by a constructed variable:

```{r}
data_oral_grouped <- data_oral_combined %>% 
  filter(!is.na(clp_class)) %>% #remove all without harmonized classif.
  filter(!is.na(category_from_exp) | category_from_exp != "not classified") %>% #remove all studies with no classification from experimental studies
  group_by(cas) %>% 
  summarize(single_category = mean(as.numeric(str_replace(category_from_exp, "not classified", "5")), na.rm = TRUE), #na.rm = TRUE is redundant; not classified treated as numerical value of 5
            clp_class = tail(names(sort(table(clp_class))), 1),
            n_experiment = sum(!is.na(category_from_exp))
            ) %>% 
  # concern = 2 for experimental data which deviate > 1 from current classification
  # concern = 1                                     < 1 > 0
  # concern = 0 else
  mutate(numeric_clp_class = as.numeric(str_extract(clp_class, "\\d")), #treat not classified as numerical value 5
         concern = ifelse(single_category < numeric_clp_class - 1, 2, 
                         ifelse(single_category < numeric_clp_class, 1, 0)
                          )
         )

# plot
data_oral_grouped %>% 
  ggplot(aes(x = factor(clp_class), y = single_category, size = n_experiment, color = factor(concern))) +
  geom_point(alpha = 0.4, position = position_jitter())
```

### Closer look at those with concern > 1

Extend the data on single experiments with the derived info from grouping by substances and plot substances of high concern

```{r}
data_oral_extended <- data_oral_combined %>% 
  inner_join(data_oral_grouped, by = c("cas", "clp_class"))

```




```{r}
data_oral_extended %>% 
  filter(concern > 1) %>% 
  ggplot(aes(x = factor(clp_class), y = category_from_exp, color = substance, shape = reliability)) +
  geom_point(alpha = 0.5, position = position_dodge(0.3), size = 5)
  

```


  
### same for concern = 1

```{r}
data_oral_extended %>% 
  filter(concern >= 1) %>% 
  ggplot(aes(x = factor(clp_class), y = category_from_exp, color = substance, shape = reliability)) +
  geom_point(alpha = 0.5, position = position_dodge(0.5), size = 5) +
  theme(legend.position="none")
  
```
  
Visualization not really useful.
trying aligned dot plot, amount of studies as dot size:

```{r}
data_oral_extended %>% 
  filter(concern >= 1) %>% 
  pull(substance) %>% 
  unique %>% 
  length
  
```  

```{r substances_of_concern_plot, out.width = "100%"}
plot_substances_of_concern <- data_oral_extended %>% 
  filter(concern >= 1) %>% 
  arrange(single_category) %>% 
  ggplot(aes(x = fct_reorder(substance, single_category, min), y = category_from_exp, color = as.factor(numeric_clp_class))) + # fct_reorder to order factor from lowest single_category to highest
  geom_count() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(label = function(x) substring(x, 1, 20))

plot_substances_of_concern

```  


### closer look at identified substances of concern

```{r}
data_oral_extended %>% 
  filter(concern >= 2) %>% 
  arrange(single_category)
```
ToDo:

Only 1 substance with a difference > 2 between current CLH and classification derived from experimental data. However, only 2 experimental values and the difference in the effective dose is huge! Suspicion: there are some entries where the unit is not the same, thus severe differences in effect levels
```{r}
data_oral_extended %>% 
  pull(unit) %>% 
  table
```
Nope.

### Interactive visualization and comparison with registration dossiers

```{r out.width = "100%"}

plot_substances_of_concern_plotly <- data_oral_extended %>% 
  filter(concern >= 1) %>% 
#  arrange(single_category) %>% 
  group_by(substance, category_from_exp) %>% 
  mutate(
    plot_label = paste(paste(ifelse(is.na(effect_level_quantifier), "  ", effect_level_quantifier)
                              , effect_level_dose, unit, "- reliability:", reliability, sep = " "),
                        sep = "", collapse = "\n")
  ) %>% 
  ggplot(aes(x = fct_reorder(substance, single_category, min), y = category_from_exp, color = as.factor(numeric_clp_class), label = plot_label))  + # fct_reorder to order factor from lowest single_category to highest
  geom_count() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_x_discrete(label = function(x) substring(x, 1, 20))

ggplotly(plot_substances_of_concern_plotly,
         tooltip = c("label")) # instead of "all"

``` 

Comparing the substances with concern > 1 with registration data
```{r getting links to dossiers concern > 1}
data_oral_extended %>% 
  filter(concern > 1) %>% 
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, link)
```

#### 1,2-epoxybutane  
Interesting case, eChemportal exported 2 studies with same reliability but tremendous difference in the effect level concentration relevant for classification. Looking at the dossier [https://echa.europa.eu/registration-dossier/-/registered-dossier/13837//?documentUUID=7f00ec16-d9ee-4ab2-b8a9-35fd844a73e5](link) shows there are actually 4 studies with RL 1 or 2, although only 2 can be found in eChemPortal (could be because cChemPortal is lagging a bit behind with the data?). Also the UUID seem to have changed. The reason for the big difference in the effect level concentration is a mistake in the dossier: LD50 is reported as 1 mg/kg bw, but is 1 g/kg bw (obvious when looking at the freetext field "mortality").
Great start...first substance and already a mistake in the dossier and already 2/4 available studies covered by the experimental data set.

Comparing the substances with concern = 1 with registration data
```{r getting links to dossiers concern 1}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, link)
```
Many important substances in this list. looking at some examples.

```{r}
data_oral_extended %>% 
  filter(concern == 1) %>% 
  filter(str_detect(substance, "peracetic acid")) %>% 
  select(substance, ec, effect_level_quantifier, effect_level_dose, unit, reliability, numeric_clp_class, category_from_exp, link)
```


### peracetic acid  
Huge number of studies indicating all 4 categories, several RL1. UUIDs also don't match for this substance. I didn't check all study records in the dossier, but there is one very obvious problem here: in addition to the LD50 of the pure substance, also LD50 of formulations are reported (with consequently considerably higher LD50 values). It seems a viable solution, to only consider the lowest value reported within each study, this should get rid off prepaations with diluted substance (+ keeps the lower valu in case there is a gender difference)


Overall the classification as Category 2 seems to be very well justified based on the experimental data.

### cyclohexylamine
According to the eChemPortal data there are 2 studies, same reliability, different categories. The registration dossier has 3 study records with RL <= 2. Again, for the studies in eChemPortal in my data only 1 effect concentration can be found, although there are more in the dossier. In this case the data I am working with even is the NOAEL, while the LD50 is the missing value. Manual check in eChemPortal shows that the LD50s **are** there - need to check why I am losing those.

In this case, category 2, as predicted from this analysis is **not** justified. Should be cat 4 and the minimal classification is not erroneous.

```{r sessioninfo}
sessioninfo()
```

